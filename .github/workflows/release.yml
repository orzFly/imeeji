name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (without v prefix)"
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      DENO_NO_PACKAGE_JSON: 1
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" deno.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          sed -i "s/const VERSION = \"dev\"/const VERSION = \"$VERSION\"/" src/main.ts

      - run: deno fmt
      - run: deno task test
      - run: deno task build

      - name: Add shebang
        run: sed -i '1i#!/usr/bin/env node' dist/imeeji.js

      - name: Verify build
        run: node dist/imeeji.js --version

      - name: Upgrade npm
        run: npm install -g npm@latest

      - name: Publish to npm
        run: npm publish --provenance

      - name: Publish to JSR
        run: deno publish --allow-dirty

      - name: Extract release notes
        id: notes
        run: |
          TAG="${GITHUB_REF_NAME}"
          COMMIT=$(git rev-list -n 1 "$TAG")
          BODY=$(git log -1 --format='%b' "$COMMIT" \
            | awk '/^[A-Za-z][A-Za-z-]*-[Bb]y: /{next} {print}' \
            | awk 'NF{found=1} found' \
            | tac | awk 'NF{found=1} found' | tac)
          {
            echo "body<<RELEASE_NOTES_EOF"
            echo "$BODY"
            echo "RELEASE_NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: ${{ steps.notes.outputs.body }}
          files: dist/imeeji.js
